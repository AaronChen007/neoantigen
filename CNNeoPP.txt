1. Quality control (fastqc)
file path/fastqc file path/file name.fastq.gz -o file path/file name

2. Remove sequencing adapter sequences and low-quality reads (Trimmomatic)
java -jar file path/trimmomatic-0.39.jar PE \
-phred33 \
-threads 30 \
file path/file name1.fq.gz file name2.fq.gz \
file path/output_file name1paired.fastq.gz output_file name1unpaired.fastq.gz \
file path/output_file name2paired.fastq.gz output_file name2unpaired.fastq.gz \
ILLUMINACLIP:file path/TruSeq3-PE.fa:2:30:10 \
SLIDINGWINDOW:5:20 \
LEADING:5 \
TRAILING:5 \
MINLEN:50

3. Alignment (BWA)
bwa index -a bwtsw  Homo_sapiens_assembly38.fasta
bwa mem -t 6 -M -R '@RG\tID:foo_lane\tPL:illumina\tLB:library\tSM:GAJ_Z' file path/Homo_sapiens_assembly38.fasta.64 output_file name1paired.fastq.gz output_file name2paired.fastq.gz | samtools view -S -b - > file path/file name.bam

4. Sort (samtools)
time samtools sort -@ 4 -m 4G -O bam -o file name.sorted.bam  file name.bam

5. Mark and remove PCR duplicates (Picard)
java -jar file path/picard.jar MarkDuplicates -REMOVE_DUPLICATES true -I file path/file name.sorted.bam -O file name.sorted.markdup.bam -M file name.markdup_metrics.txt
samtools index file name.sorted.markdup.bam

6. Base quality recalibration (GATK4.4)
gatk BaseRecalibrator \
 -R file path/Homo_sapiens_assembly38.fasta \
 -I file path/file name.sorted.markdup.bam \
 --known-sites file path/Homo_sapiens_assembly38.dbsnp138.vcf \
 --known-sites file path/Mills_and_1000G_gold_standard.indels.hg38.vcf.gz \
 --known-sites file path/1000G_phase1.snps.high_confidence.hg38.vcf.gz \
 -O file name_recal_data.table

gatk ApplyBQSR \
 -R file path/Homo_sapiens_assembly38.fasta \
 -I file path/file name.sorted.markdup.bam \
 --bqsr-recal-file file name_recal_data.table \
 -O file name_recalibrated.bam

7. Estimate contamination (GATK4.4)
gatk GetPileupSummaries \
 -I normal file name_recalibrated.bam \
 -V file path/small_exac_common_3.hg38.vcf.gz \
 -L file path/small_exac_common_3.hg38.vcf.gz \
 -O file path/normal file name_getpileupsummaries.table

gatk GetPileupSummaries \
 -I tumor file name_recalibrated.bam \
 -V file path/small_exac_common_3.hg38.vcf.gz \
 -L file path/small_exac_common_3.hg38.vcf.gz \
 -O file path/tumor file name_getpileupsummaries.table 

gatk CalculateContamination \
 -I tumor file name_getpileupsummaries.table \
 -matched normal file name_getpileupsummaries.table \
 -tumor-segmentation segments.table \
 -O file name_calculatecontamination.table

8. Somatic variant calling (Mutect2)
gatk Mutect2 -R file path/Homo_sapiens_assembly38.fasta -I file path/tumor file name_recalibrated.bam -tumor tumor file name -I file path/normal file name_recalibrated.bam -normal normal file name -pon file path/1000g_pon.hg38.vcf.gz --germline-resource file path/af-only-gnomad.hg38.vcf.gz -L file path/wgs_calling_regions.hg38.interval_list -O file name_somatic.vcf.gz -bamout file name_tumor_normal.bam

9. Mutation filtering (GATK 4.4)
gatk FilterMutectCalls \
 -R file path/Homo_sapiens_assembly38.fasta \
 -V file path/file name_somatic.vcf.gz \
 --contamination-table file path/file name_calculatecontamination.table \
 --stats file path/file name_somatic.vcf.gz.stats \
 --tumor-segmentation file path/segments.table \
 -O file name_somatic_oncefiltered.vcf.gz
 
10. Keep only PASS (GATK 4.4)
gatk SelectVariants -R file path/Homo_sapiens_assembly38.fasta -V file path/file name_somatic_oncefiltered.vcf.gz -select "vc.isNotFiltered()"  -O file path/file name_somatic_oncefiltered_SelectVariants-filtered.vcf

11. Annotation (Annovar)
time file path/table_annovar.pl file path/file name_somatic_oncefiltered_SelectVariants-filtered.vcf file name/annovar/humandb/ -buildver hg38 -out file path/file name -remove -protocol refGene,cytoBand,exac03,avsnp147,dbnsfp30a -operation gx,r,f,f,f -nastring . -vcfinput -polish && echo "** annotation done **"

12. Gene expression (Kallisto)
kallisto index -i kallisto_index file name/Homo_sapiens.GRCh38.cdna.all.fa
kallisto quant -i kallisto_index -o file_name file_name/file name1_cutadapted.fastq.gz file_name/file name2_cutadapted.fastq.gz

13.HLA typing (Optitype)
razers3 -i 95 -m 1 -dr 0 -o file path/fished_1.bam file path/hla_reference_dna.fasta output_file name_paired.fastq
samtools bam2fq fished_1.bam > output_file name_paired_fished.fastq
python OptiTypePipeline.py -i sample_fished_1.fastq sample_fished_2.fastq --dna -v -o output_dir 

14. Binding affinity (NetMHCpan-4.1)
https://services.healthtech.dtu.dk/services/NetMHCpan-4.1/

15. Immunogenicity prediction using CNNeo
The corresponding codes are provided in the CNNeo_model directory.



